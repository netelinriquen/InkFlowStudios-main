<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Agendamentos - Ink Flow</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="icon" type="image/png" href="../assets/images/favicon-round.png">
    <style>
        .client-area {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            margin-top: 80px;
        }
        .welcome-section {
            background: var(--gradient-card);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .appointments-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .appointment-card {
            background: var(--gradient-card);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--tertiary-dark);
        }
        .appointment-status {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-confirmado { background: #4CAF50; color: white; }
        .status-pendente { background: #FF9800; color: white; }
        .status-cancelado { background: #F44336; color: white; }
        .logout-btn {
            background: var(--accent-red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="../index.html" class="logo">INK FLOW</a>
            <ul class="nav-links">
                <li><a href="../index.html">Home</a></li>
                <li><a href="sobre.html">Sobre Nós</a></li>
                <li><a href="portfolio.html">Portfólio</a></li>
                <li><a href="servicos.html">Serviços</a></li>
                <li><a href="agendamento.html">Agendamento</a></li>
                <li><a href="contato.html">Contato</a></li>
            </ul>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </nav>
    </header>

    <main class="client-area">
        <div class="welcome-section">
            <h1>Bem-vindo, <span id="user-name">Cliente</span>!</h1>
            <p>Aqui você pode acompanhar todos os seus agendamentos</p>
        </div>

        <section>
            <h2>Meus Agendamentos</h2>
            <div class="appointments-grid" id="appointments-list">
                <!-- Agendamentos serão carregados aqui -->
            </div>
        </section>
    </main>

    <footer>
        <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem;">
            <a href="https://www.instagram.com/inkflowstudios" target="_blank" style="color: var(--text-gray); text-decoration: none; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; transition: all 0.3s ease;" aria-label="Instagram">Instagram</a>
            <a href="https://www.tiktok.com/@inkflowstudios" target="_blank" style="color: var(--text-gray); text-decoration: none; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; transition: all 0.3s ease;" aria-label="TikTok">TikTok</a>
            <a href="https://wa.me/15144373894" target="_blank" style="color: var(--text-gray); text-decoration: none; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; transition: all 0.3s ease;" aria-label="WhatsApp">WhatsApp</a>
            <a href="mailto:inkflowstudios07@gmail.com" target="_blank" style="color: var(--text-gray); text-decoration: none; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; transition: all 0.3s ease;" aria-label="Email">Email</a>
        </div>
        <div style="text-align: center; color: var(--text-gray); font-size: 0.9rem;">
            <p>&copy; 2025 Ink Flow Estúdio de Tatuagem Ltda. Todos os direitos reservados.</p>
            <p>São Paulo, SP - Brasil | CNPJ: 00.000.000/0001-00</p>
        </div>
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/appointment-sync.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/global-auth.js"></script>
    <script src="../assets/js/login-fix.js"></script>
    <script>
        // Verificar se está logado
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.authSystem || !window.authSystem.isLoggedIn()) {
                alert('Você precisa fazer login para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }
            
            // Carregar dados do usuário
            const currentUser = window.authSystem.getCurrentUser();
            if (currentUser) {
                const userName = currentUser.name || currentUser.email.split('@')[0];
                document.getElementById('user-name').textContent = userName;
            }
            
            // Carregar agendamentos
            loadAppointments();
            
            // Escutar mudanças em tempo real
            if (window.DataSync) {
                DataSync.subscribe('appointments', function(data) {
                    console.log('Atualização de agendamento recebida:', data);
                    loadAppointments(); // Recarregar lista
                });
            }
            
            // Escutar eventos de sincronização entre abas
            window.addEventListener('dataSync', function(event) {
                if (event.detail.type === 'appointments') {
                    console.log('Sincronização entre abas:', event.detail);
                    loadAppointments();
                }
            });
            
            // Escutar mudanças no localStorage
            window.addEventListener('storage', function(event) {
                if (event.key === 'appointments') {
                    console.log('LocalStorage atualizado');
                    loadAppointments();
                }
            });
        });

        // Carregar agendamentos do banco
        let appointments = [];

        async function loadAppointments() {
            const currentUser = window.authSystem.getCurrentUser();
            if (!currentUser) return;
            
            try {
                // Tentar carregar do SQL Server
                const response = await fetch('http://localhost:3001/appointments');
                const allAppointments = await response.json();
                
                // Filtrar agendamentos do usuário atual
                appointments = allAppointments.filter(apt => 
                    apt.email === currentUser.email || 
                    apt.cliente_nome === currentUser.name
                );
                
                console.log('✅ Agendamentos carregados do SQL Server:', appointments.length);
            } catch (error) {
                console.log('❌ Erro ao carregar do SQL Server, usando localStorage');
                // Fallback para localStorage
                const localAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                appointments = localAppointments.filter(apt => 
                    apt.userId === currentUser.id || 
                    apt.userEmail === currentUser.email
                );
            }
            
            renderAppointments();
        }

        function renderAppointments() {
            const container = document.getElementById('appointments-list');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-gray);">
                        <h3>Nenhum agendamento encontrado</h3>
                        <p>Você ainda não possui agendamentos.</p>
                        <a href="agendamento.html" class="btn" style="margin-top: 1rem;">Fazer Agendamento</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = appointments.map(appointment => {
                const status = appointment.status || 'pendente';
                const statusText = {
                    'pending': 'PENDENTE',
                    'pendente': 'PENDENTE', 
                    'confirmed': 'CONFIRMADO',
                    'confirmado': 'CONFIRMADO',
                    'cancelled': 'CANCELADO',
                    'cancelado': 'CANCELADO'
                }[status] || status.toUpperCase();
                
                return `
                    <div class="appointment-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--accent-red);">${appointment.service || 'Tatuagem Personalizada'}</h3>
                            <span class="appointment-status status-${status}">${statusText}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <p><strong>Nome:</strong> ${appointment.name || 'Não informado'}</p>
                                <p><strong>Telefone:</strong> ${appointment.phone || 'Não informado'}</p>
                                <p><strong>Idade:</strong> ${appointment.age || 'Não informado'} anos</p>
                                <p><strong>Artista:</strong> ${getArtistName(appointment.artist)}</p>
                                <p><strong>Tamanho:</strong> ${getSizeName(appointment.size)}</p>
                            </div>
                            <div>
                                <p><strong>Local:</strong> ${appointment.location || 'Não especificado'}</p>
                                <p><strong>Orçamento:</strong> ${appointment.budget || 'A definir'}</p>
                                <p><strong>Primeira tatuagem:</strong> ${appointment.firstTattoo ? 'Sim' : 'Não'}</p>
                                <p><strong>Data:</strong> ${formatDate(appointment)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <p><strong>Descrição:</strong> ${appointment.description || 'Nenhuma descrição fornecida'}</p>
                            <p><strong>Disponibilidade:</strong> ${appointment.availability || 'Não especificado'}</p>
                        </div>
                        ${(status === 'pending' || status === 'pendente') ? 
                            `<button onclick="cancelAppointment(${appointment.id})" style="background: var(--accent-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 1rem;">Cancelar Solicitação</button>` : 
                            ''
                        }
                    </div>
                `;
            }).join('');
        }
        
        function getArtistName(artist) {
            const artists = {
                'marcus': 'Marcus Silva (Realismo)',
                'ana': 'Ana Costa (Fine Line/Aquarela)', 
                'rafael': 'Rafael Santos (Geométrico/Tradicional)',
                'carla': 'Carla Mendes (Blackwork)'
            };
            return artists[artist] || artist || 'Sem preferência';
        }
        
        function getSizeName(size) {
            const sizes = {
                'pequena': 'Pequena (até 5cm)',
                'media': 'Média (5-15cm)',
                'grande': 'Grande (15cm+)'
            };
            return sizes[size] || size || 'Não especificado';
        }
        
        function formatDate(appointment) {
            if (appointment.createdAt) {
                return new Date(appointment.createdAt).toLocaleDateString('pt-BR');
            }
            if (appointment.date) {
                return new Date(appointment.date).toLocaleDateString('pt-BR');
            }
            return 'Data não disponível';
        }

        function cancelAppointment(id) {
            if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
                const updated = AppointmentSync.updateAppointmentStatus(id, 'cancelado');
                if (updated) {
                    loadAppointments();
                    alert('❌ Agendamento cancelado com sucesso!');
                } else {
                    alert('Erro ao cancelar agendamento. Tente novamente.');
                }
            }
        }

        function logout() {
            if (window.authSystem) {
                window.authSystem.logout();
            } else {
                window.safeLogout();
            }
        }

        // Remover esta linha pois agora o carregamento é feito no DOMContentLoaded
    </script>
</body>
</html>